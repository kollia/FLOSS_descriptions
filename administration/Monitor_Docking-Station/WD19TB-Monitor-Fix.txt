Ich hatte bereits eine Unterhaltung √ºber meine Dell WD19TB Thunderbolt Dock Probleme. 
Das Problem: Nach Herunterfahren/Standby und Dock ausschalten wird der externe Monitor 
beim Neustart nicht immer erkannt. Wir hatten bereits folgende Diagnose gemacht:
- Dell XPS 9550 mit WD19TB
- Monitor l√§uft √ºber DP-1-3 
- MST ist aktiviert (enable_dp_mst=Y)
- Thunderbolt wird erkannt
K√∂nnen wir mit den L√∂sungsans√§tzen fortfahren?
(Ich m√∂chte zum besseren Verst√§ndnis alle Befehle auf der command-line selbst ausf√ºhren)


Dell WD19TB Thunderbolt Dock - Monitor Detection Fix
=====================================================
Benutzerhandbuch:
https://www.dell.com/support/manuals/de-at/dell-wd19tb-dock/wd19_tb_userguide/symptome-und-l%c3%b6sungen?guid=guid-632fc953-271d-4d76-9151-2ad1dae1b746

Problem: Externer Monitor wird nach Standby/Herunterfahren nicht erkannt

Dell WD19TB Thunderbolt Dock - Monitor Detection Fix
=====================================================

Problem: Externer Monitor wird nach Standby/Herunterfahren nicht erkannt

Hardware:
- Dell XPS 9550
- Dell WD19TB Thunderbolt Dock  
- Monitor: Samsung C27F390 √ºber DP-1-3 (MST-Port)
- Laptop Display: Sharp Corporation (eDP-1)

FUNKTIONIERENDER ZUSTAND (6. Aug 2025 - 18:30):
----------------------------------------------
‚úÖ Thunderbolt Dock wird erkannt (0-1, autorisiert)
‚úÖ Monitor verbunden √ºber DP-1-3 (1920x1080, prim√§r)
‚úÖ DP-5 (card1-DP-5) ist connected (MST-Branch)
‚úÖ Laptop-Display eDP-1 verf√ºgbar aber standardm√§√üig inaktiv
‚ùå DDC/CI communication failed (Samsung C27F390)

EDID-Daten Samsung C27F390:
---------------------------
- Hersteller: Samsung (SAM, 4c2d)
- Modell: C27F390 (Product code: 0x0d32)
- Seriennummer: HTQK300099 (Binary: 0x30503645)
- Herstellungsjahr: 2015, Woche 46
- i2c-Bus: /dev/i2c-8 (DDC fehlgeschlagen)

Verhalten bei Laptop-Deckel √∂ffnen:
-----------------------------------
‚úÖ DP-1-3 bleibt prim√§rer Monitor
‚úÖ card1-DP-5 bleibt connected
‚ùå eDP-1 wird nicht automatisch aktiviert (ben√∂tigt manuellen xrandr-Befehl)
‚ùå DDC-Kommunikation funktioniert nicht mit --bus Parameter

Dual-Display Konfiguration (funktionierend):
--------------------------------------------
‚úÖ Beide Displays aktiv nach: xrandr --output eDP-1 --auto --right-of DP-1-3
‚úÖ eDP-1: 1920x1080+1920+0 (Sharp, rechts vom Samsung)
‚úÖ DP-1-3: 1920x1080+0+0 primary (Samsung C27F390, links)
‚ùå DDC communication failed (keine Software-Steuerung des Samsung m√∂glich)

DDC/CI Status:
--------------
‚ùå Samsung C27F390: "DDC communication failed" (i2c-8, card1-DP-5)
‚ùå Sharp Laptop: "Laptop displays do not support DDC/CI" (i2c-5, card1-eDP-1)
‚Üí Monitor kann NICHT per Software aufgeweckt werden
‚Üí Physisches Aufwecken des Monitors ist erforderlich

Verf√ºgbare DP-Ports im funktionierenden Zustand:
------------------------------------------------
- card1-DP-1: disconnected
- card1-DP-2: disconnected  
- card1-DP-3: disconnected
- card1-DP-4: disconnected
- card1-DP-5: connected (MST-Branch ‚Üí DP-1-3)
- DP-1-3: connected primary (1920x1080+0+0, Samsung C27F390)

Aktuelle Hardware-Status (6. Aug 2025):
---------------------------------------
‚úÖ Thunderbolt Dock wird erkannt (0-1)
‚úÖ Thunderbolt ist autorisiert (authorized: 1)
‚úÖ DP-Ports sind verf√ºgbar (card1-DP-1, card1-DP-2)
‚ùå Beide DP-Ports zeigen "disconnected"
‚ùå Monitor ist im Standby und sucht keine Verbindung

Verf√ºgbare DP-Port Dateien:
---------------------------
- /sys/class/drm/card1-DP-1/status (rw-r--r--)
- /sys/class/drm/card1-DP-2/status (rw-r--r--)  
- /sys/class/drm/card1-DP-*/uevent (rw-r--r--)
- Keine detect/force Dateien verf√ºgbar

Getestete L√∂sungsans√§tze:
------------------------
1. ‚úÖ echo change | sudo tee /sys/class/drm/card1-DP-*/uevent  # Hotplug-Event triggern
2. ‚úÖ echo 1 | sudo tee /sys/bus/pci/rescan                    # PCI-Bus neu scannen  
3. ‚ùå Status-Datei beschreiben (nicht unterst√ºtzt)
4. ‚ùå Automatische DP-Detection (keine detect/force Dateien)

Script: dock-monitor-fix.sh
---------------------------
Erstellt f√ºr automatische Problemdiagnose und -behebung:
- ./dock-monitor-fix.sh status    # Aktueller Status
- ./dock-monitor-fix.sh rescan    # DP-Ports neu scannen
- ./dock-monitor-fix.sh reauth    # Thunderbolt neu autorisieren  
- ./dock-monitor-fix.sh fix       # Vollst√§ndiger Fix-Versuch

Erweiterte Diagnose:
--------------------
ls -la /sys/bus/thunderbolt/devices/            # Thunderbolt-Ger√§te anzeigen
cat /sys/bus/thunderbolt/devices/0-1/authorized # Autorisierungsstatus pr√ºfen
ls -la /sys/class/drm/                          # DRM-Karten und Ports anzeigen
for port in /sys/class/drm/card1-DP-*; do echo "=== $port ==="; cat "$port/status" 2>/dev/null || echo "No status file"; done

Schnelle L√∂sungen (wenn Problem auftritt):
-------------------------------------------
1. Monitor physisch aktivieren:
   - Monitor-Einschaltknopf dr√ºcken / aus Standby wecken
   - Warten bis Monitor aktiv nach Signal sucht
   - Dann DP-Detection triggern

2. DP-Hotplug Events triggern (MST-aware):
   echo change | sudo tee /sys/class/drm/card1-DP-5/uevent    # MST-Branch
   echo change | sudo tee /sys/class/drm/card1-DP-1/uevent
   echo change | sudo tee /sys/class/drm/card1-DP-2/uevent
   xrandr --auto

3. Thunderbolt neu initialisieren (MST-aware):
   echo 0 | sudo tee /sys/bus/thunderbolt/devices/0-1/authorized
   sleep 2
   echo 1 | sudo tee /sys/bus/thunderbolt/devices/0-1/authorized
   sleep 2
   xrandr --output DP-1-3 --auto || xrandr --output DP-1 --auto || xrandr --output DP-2 --auto

4. Script verwenden:
   ./dock-monitor-fix.sh fix

5. i915 Treiber neu laden (Notfall):
   sudo modprobe -r i915
   sudo modprobe i915

Permanente L√∂sungen (wenn Problem h√§ufig auftritt):
--------------------------------------------------
1. MST deaktivieren:
   # In /etc/default/grub hinzuf√ºgen:
   GRUB_CMDLINE_LINUX="i915.enable_dp_mst=0"
   sudo grub2-mkconfig -o /boot/grub2/grub.cfg

2. Udev-Regel f√ºr automatische Wiederherstellung:
   # /etc/udev/rules.d/90-thunderbolt-monitor.rules
   ACTION=="change", SUBSYSTEM=="drm", ENV{HOTPLUG}=="1", RUN+="/usr/local/bin/dock-monitor-fix.sh"

3. Systemd-Service f√ºr Monitor nach Standby:
   # Monitor-Fix nach Resume aus Standby

Status: 
-------
‚úÖ Thunderbolt Dock wird erkannt
‚úÖ Monitor funktioniert wenn alles l√§uft  
‚ùå Sporadische Probleme nach Standby/Neustart

N√§chste Schritte:
-----------------
üîÑ N√ÑCHSTE SITZUNG:
1. Monitor aus Standby wecken und testen ob Script funktioniert
2. Monitor-Wake-Up per Software implementieren (DDC/CI commands)
3. Automatisches Monitor-Wake-Up Script erstellen
4. Udev-Regel f√ºr automatische Behandlung nach Resume
5. Systemd-Service f√ºr Monitor-Fix nach Standby

üîÑ F√ºr die n√§chste Sitzung wenn das Problem auftritt:

1. Script mit MST-Support testen
2. Physisches Monitor-Aufwecken als prim√§re L√∂sung
3. Hotplug-Events f√ºr card1-DP-5 triggern

üí° ERKENNTNISSE:
- Problem liegt wahrscheinlich am Monitor-Standby, nicht am Dock
- Thunderbolt-Verbindung funktioniert korrekt
- DP-Ports sind verf√ºgbar aber Monitor antwortet nicht
- Hotplug-Events k√∂nnen getriggert werden
- Script-Framework ist einsatzbereit

üí° NEUE ERKENNTNISSE (7. Aug 2025):
-----------------------------------
- NVIDIA vs Intel i915 Konflikt verursacht Boot-Probleme (60+ Sekunden)
- i915 MST Link Address Fehler: "Sending link address failed with -5" 
- NVIDIA kann keine CRT-Controller finden (i915 hat sie bereits)
- MariaDB Service Timeout verst√§rkt Boot-Verz√∂gerungen
- Thunderbolt PCIe bridge allocation failures
- ACPI thermal zone Fehler k√∂nnen Power-Management beeintr√§chtigen

üîó MONITOR-PROBLEM VERBINDUNG:
- Das sporadische Monitor-Problem ist direkt mit NVIDIA/i915 Konflikt verbunden
- NVIDIA versucht vergeblich Display-Kontrolle zu √ºbernehmen
- i915 MST-Fehler betreffen direkt DP-1-3 Verbindung
- Boot-Instabilit√§t f√ºhrt zu unvorhersagbarem Display-Verhalten

‚ö†Ô∏è EMPFEHLUNG:
- NVIDIA komplett deaktivieren ‚Üí behebt 80% der Boot- und Monitor-Probleme
- Siehe: Boot-Performance-Analysis.txt f√ºr detaillierte L√∂sungen

üìù TODO:
- Monitor-DDC/CI Befehle testen (ddcutil)
- Power-Management des Monitors untersuchen
- Wake-on-DisplayPort M√∂glichkeiten pr√ºfen
